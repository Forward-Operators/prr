{% include "_header.html" %}

{% from "_run_helpers.html" import render_pills with context %}
{% from "_run_helpers.html" import primary_service_list with context %}
{% from "_run_helpers.html" import primary_run_list with context %}
{% from "_run_helpers.html" import render_stats with context %}

<div>
  {{ primary_service_list(all_service_names, primary.service_name, primary.run_id) }}

  <div id="run-list-and-content">

    {{ primary_run_list(all_runs, primary.service_name, primary.run_id) }}

    <div id="run">
      {% include "_menu.html" %}

      <h2>PROMPT RUN REPORT</h2>

      <section>
        <div class="service-name">
          {{ primary.service_name }} (run #{{ primary.run_id }})
        </div>
        <div class="model-name">{{ primary.run_details.request.model }}</div>
        <div class="service-description">
          {{ render_pills(primary.run_details.request.options.items()) }}
        </div>    
      </section>

      
      <h2>PROMPT</h2>
      
      <div class="text-container">
        <div id="primary-prompt-text">{{ primary.prompt_content }}</div>
      </div>
    
      <h2>OUTPUT</h2>
    
      <div class="text-container">
        <div id="primary-output-text">{{ primary.output_content }}</div>
      </div>
    
      <h2>RESPONSE</h2> 
    
      <section>
        <div class="response-description">
          {{ render_pills(primary.run_details.response.items()) }}
        </div>
      </section>
      
      <h2>STATS</h2> 
      
      <section id="stats">
        {{ render_stats(primary.run_details.stats) }}
      </section>
      
    </div>
</div>

<script>
  let currentState = ''

  function state2str (data) {
    return data['all_runs'].map((run) => [run['run_id'], run['state']].join('|')).join(':')
  }

  function checkState() {
    console.log('checkState current state:', currentState)
    fetch('/runs/state', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json()) // Parse the response as JSON
    .then(data => {
      if (currentState != ''){
        if(currentState != state2str(data)) {
          console.log('we need reload. current state', currentState)
          console.log('data', state2str(data))
          window.location.reload()
        }
      }

      currentState = state2str(data)
    })
    .catch((error) => {
      console.error('Error:', error); // Log any errors
    });
  }

  setInterval(checkState, 1000)
</script>

{% include "_footer.html" %}