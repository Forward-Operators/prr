{% include "_header.html" %}

{% from "_run_helpers.html" import render_pills with context %}
{% from "_run_helpers.html" import primary_service_list with context %}
{% from "_run_helpers.html" import primary_run_list with context %}
{% from "_run_helpers.html" import secondary_service_list with context %}
{% from "_run_helpers.html" import secondary_run_list with context %}
{% from "_run_helpers.html" import render_stats with context %}
{% from "_run_helpers.html" import render_diff_pills with context %}

<div id="main">
  {{ primary_service_list(all_service_names, run.service_name, run.run_id ) }}

  <div id="run-list-and-content">

  {{ primary_run_list(all_runs, run.service_name, run.run_id) }}

  <div id="run">
    {% include "_menu.html" %}

    {% if run.state == 'in-progress' %}
      <h2>
        this run is still in progress...
      </h2>
    {% else %}
      <h2>PROMPT RUN COMPARISON</h2>

      <section>
        <div class="run-comparison">
          <div>
            <div class="service-name">
              {{ run.service_name }} (run #{{ run.run_id }})
            </div>
            <div class="model-name">{{ run.run_details.request.model }}</div>
            <div class="service-description">
              {{ render_diff_pills(run.run_details.request.options, run2.run_details.request.options) }}
            </div>    
          </div>
          <div>
            <div class="service-name">
              {{ run2.service_name }} (run #{{ run2.run_id }})
            </div>
            <div class="model-name">{{ run2.run_details.request.model }}</div>
            <div class="service-description">
              {{ render_diff_pills(run2.run_details.request.options, run.run_details.request.options) }}
            </div>
          </div>
        </div>
      </section>

      
      <h2>PROMPT</h2>
      
      <div id="primary-prompt-text" class="hidden">{{ run.prompt_content }} </div>
      <div id="secondary-prompt-text" class="hidden">{{ run2.prompt_content }} </div>
      <div class="text-container">
        <div id="prompt-text-diff"></div>
      </div>
    
      <h2>OUTPUT</h2>
    
      <div id="primary-output-text" class="hidden">{{ run.output_content }} </div>
      <div id="secondary-output-text" class="hidden">{{ run2.output_content }} </div>
      <div class="text-container">
        <div id="output-text-diff"></div>
      </div>
    
      <h2>RESPONSE</h2> 
    
      <section>
        <div class="run-comparison">
          <div class="response-description">
            {{ render_diff_pills(run.run_details.response, run2.run_details.response) }}
          </div>
          <div class="response-description">
            {{ render_diff_pills(run2.run_details.response, run.run_details.response) }}
          </div>    
        </div>
      </section>
      
      <h2>STATS</h2> 
      
      <section id="stats">
        <div class="run-comparison">
          {{ render_stats(run.run_details.stats) }}
          {{ render_stats(run2.run_details.stats) }}
        </div>
      </section>
    {% endif %}
  </div>

  {{ secondary_run_list(all_runs, run.service_name, run.run_id, run2.service_name, run2.run_id) }}
</div>

  {{ secondary_service_list(all_service_names, run.service_name, run.run_id, run2.service_name, run2.run_id) }}
</div>

<script>
  function diff(primaryID, secondaryID, outputID) {
    var dmp = new diff_match_patch();
    var primaryText = document.getElementById(primaryID).innerText;
    var secondaryText = document.getElementById(secondaryID).innerText;

    var d = dmp.diff_main(secondaryText, primaryText);
    dmp.diff_cleanupSemantic(d);
    const diff = dmp.diff_prettyHtml(d);
    document.getElementById(outputID).innerHTML = diff;
  }

  diff('primary-prompt-text', 'secondary-prompt-text', 'prompt-text-diff')
  diff('primary-output-text', 'secondary-output-text', 'output-text-diff')
</script>

{% include "_footer.html" %}